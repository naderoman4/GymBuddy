# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

GymBuddy is a mobile-friendly workout tracking application that helps users:
- Import workout plans from CSV files (generated by Gemini AI)
- Track workouts in real-time during gym sessions
- Export completed workout data back to CSV for AI analysis

**Tech Stack**: React 18, TypeScript, Vite, Tailwind CSS, Supabase (PostgreSQL), React Router v6

## Development Commands

```bash
# Install dependencies
npm install

# Start development server (runs on http://localhost:5173)
npm run dev

# Build for production
npm run build

# Preview production build
npm run preview

# Run linter
npm run lint

# Type check
npx tsc --noEmit
```

## Database Setup

The application uses Supabase (PostgreSQL) with authentication. To set up:

1. Create a Supabase project at supabase.com
2. **Enable Email Auth**: In Supabase Dashboard → Authentication → Providers → Enable Email provider
3. Run the SQL schema in `supabase-schema.sql` via the Supabase SQL Editor (creates initial tables)
4. Run the SQL migration in `supabase-auth-migration.sql` to add user authentication (adds user_id columns and RLS policies)
5. Copy `.env.example` to `.env` and add your Supabase credentials:
   - `VITE_SUPABASE_URL` - Your project URL
   - `VITE_SUPABASE_ANON_KEY` - Your anon/public key (NOT the service_role key)

**Database Tables**:
- `workouts`: Stores workout sessions (id, name, date, workout_type, status, notes, user_id)
- `exercises`: Stores individual exercises (workout_id FK, exercise details, expected vs realized values, user_id)

**Authentication**:
- Uses Supabase Auth with email/password
- Row Level Security (RLS) policies ensure users can only access their own data
- All tables filter by `auth.uid()` automatically via RLS

## Architecture

### State Management
- React Context API for authentication state (AuthContext)
- React `useState` for local component state
- Supabase client for data fetching and mutations
- No global state management library (Redux, Zustand, etc.) - each page fetches its own data

### Routing
- Client-side routing with React Router v6
- Routes defined in `src/App.tsx`:
  - `/login` - LoginPage (user authentication)
  - `/signup` - SignupPage (user registration)
  - `/` - HomePage (landing/overview) - Protected
  - `/import` - ImportPage (CSV upload with clipboard support) - Protected
  - `/calendar` - CalendarPage (month view with workout selection) - Protected
  - `/workout/:id` - WorkoutPage (detailed exercise tracking) - Protected

**Protected Routes**: All main routes except login/signup require authentication via `ProtectedRoute` component

### Data Flow

**Import Flow** (ImportPage):
1. User uploads CSV via drag-and-drop or file picker
2. PapaParse parses CSV into objects
3. Validation: ensure required fields (workout_date, workout_type, exercise fields)
4. Group exercises by workout (using workout_id or date+type)
5. Insert workouts into Supabase
6. Insert exercises with workout_id foreign keys

**Tracking Flow** (WorkoutPage):
1. Fetch workout and exercises by workout_id
2. User fills in realized_sets, realized_reps, realized_weight, notes
3. Save each exercise individually to Supabase
4. Mark workout as "done" when complete (status field)

**Export Flow** (CalendarPage):
1. Display workouts in calendar grid (date-fns for date handling)
2. User selects completed workouts (status="done") via checkboxes
3. Fetch all exercises for selected workouts
4. Convert to CSV with PapaParse and download

### Key Design Patterns

**CSV Import Validation**:
- Must have workout_id OR (workout_date + workout_type)
- If no workout_id, one is generated from date+type
- workout_name defaults to "{date} - {type}" if not provided
- Each exercise must reference a valid workout

**Date Handling**:
- All dates stored as YYYY-MM-DD strings in database
- Use `date-fns` for parsing (`parseISO`) and formatting
- Calendar uses `eachDayOfInterval`, `startOfMonth`, `endOfMonth`

**Mobile Optimization**:
- Tailwind responsive classes (`md:`, `sm:` breakpoints)
- Touch-friendly button sizes (minimum 44px tap targets)
- Single-column layouts on mobile, grid on desktop

## File Organization

```
src/
├── lib/
│   ├── supabase.ts          # Supabase client singleton
│   └── database.types.ts    # TypeScript types for DB schema (includes user_id)
├── contexts/
│   └── AuthContext.tsx      # Authentication context provider and useAuth hook
├── components/
│   └── ProtectedRoute.tsx   # Route wrapper that requires authentication
├── pages/
│   ├── HomePage.tsx         # Landing page with feature overview
│   ├── LoginPage.tsx        # User login with email/password
│   ├── SignupPage.tsx       # User registration
│   ├── ImportPage.tsx       # CSV upload/paste, parsing, validation, DB insert
│   ├── CalendarPage.tsx     # Month view, workout selection, CSV export
│   └── WorkoutPage.tsx      # Exercise tracking with real-time updates
├── App.tsx                  # Router setup, AuthProvider, navigation bar
├── main.tsx                 # React entry point
└── index.css                # Tailwind directives + global styles
```

## Important Implementation Notes

### Authentication
- **AuthContext** (`src/contexts/AuthContext.tsx`): Provides auth state globally
  - `user`: Current user object or null
  - `session`: Current session or null
  - `loading`: Boolean indicating auth state loading
  - `signUp(email, password)`: Create new account
  - `signIn(email, password)`: Login
  - `signOut()`: Logout
- **ProtectedRoute** component: Redirects to `/login` if user not authenticated
- **User Data Isolation**: RLS policies automatically filter all queries by `auth.uid()`
- **Email Confirmation**: By default Supabase requires email confirmation. Disable in Settings → Auth → Email Auth → Confirm email = OFF for development

### Supabase Client
- Initialized in `src/lib/supabase.ts` with env vars
- Uses typed client: `createClient<Database>()`
- All queries use `supabase.from('table_name')` pattern
- **Important**: Always use `user_id` when inserting workouts/exercises

### Type Safety
- Database types in `src/lib/database.types.ts` define Row, Insert, Update types
- `Workout` and `Exercise` types exported for component props
- All date strings typed as `string` (YYYY-MM-DD format)
- Both tables now include required `user_id: string` field

### CSV Format Requirements
Required columns: `workout_date`, `workout_type`, `exercise_name`, `expected_sets`, `expected_reps`, `rest_in_seconds`, `rpe`

Optional columns: `workout_id`, `workout_name`, `workout_status`, `workout_notes`, `recommended_weight`

### Workout Status States
- `"planned"` - default for new imports
- `"done"` - set when user clicks "Complete Workout"
- Only "done" workouts can be selected for export

### Foreign Key Relationships
- `exercises.workout_id` references `workouts.id`
- ON DELETE CASCADE: deleting a workout deletes its exercises
- Index on `exercises.workout_id` for performance

## Common Development Tasks

### Adding a New Page
1. Create component in `src/pages/`
2. Add route in `src/App.tsx` Routes
3. Add navigation link in Navigation component if needed

### Modifying Database Schema
1. Update `supabase-schema.sql`
2. Run SQL in Supabase SQL Editor
3. Regenerate types: Use Supabase CLI or manually update `database.types.ts`
4. Update insert/update calls in relevant pages

### Adding CSV Columns
1. Update `CSVRow` interface in `ImportPage.tsx`
2. Update validation logic in `processCSVData`
3. Update database insert in `processCSVData`
4. Update sample CSV file
5. Update README documentation

### Styling Conventions
- Use Tailwind utility classes (no CSS modules or styled-components)
- Color palette: blue (primary actions), green (success/complete), red (errors), gray (neutral)
- Spacing: 4px grid (p-4, mb-6, gap-2, etc.)
- Shadows: `shadow-md` for cards, `shadow-lg` for elevated elements

## Environment Variables

All env vars must be prefixed with `VITE_` to be accessible in the browser:
- `VITE_SUPABASE_URL` - Your Supabase project URL
- `VITE_SUPABASE_ANON_KEY` - Your Supabase anonymous key

Access with `import.meta.env.VITE_VARIABLE_NAME`

## Dependencies

**Production**:
- `react`, `react-dom` - UI framework
- `react-router-dom` - Routing
- `@supabase/supabase-js` - Database client
- `date-fns` - Date manipulation
- `papaparse` - CSV parsing/unparsing
- `lucide-react` - Icon library

**Development**:
- `vite`, `@vitejs/plugin-react` - Build tool
- `typescript` - Type checking
- `tailwindcss`, `autoprefixer`, `postcss` - Styling
- `eslint` - Linting

## Future Enhancement Areas

The original specifications mentioned these P2 features:
- Manual exercise modification during workouts (partially implemented - users can edit notes)
- Gemini API integration for automatic plan generation
- Real-time exercise substitution if equipment unavailable
- Progress analytics and charts
- User authentication (currently public access)

When implementing these, consider:
- Exercise substitution: add `substituted_for` field to exercises table
- Gemini integration: create `src/lib/gemini.ts` with API calls
- Auth: update Supabase RLS policies to filter by `auth.uid()`
